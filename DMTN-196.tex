\documentclass[DM,authoryear,toc]{lsstdoc}
% lsstdoc documentation: https://lsst-texmf.lsst.io/lsstdoc.html
\input{meta}

% Package imports go here.

% Local commands go here.
\defcitealias{2016ApJ...830...27Z}{ZOGY}
\defcitealias{1998ApJ...503..325A}{A\&L}
\newcommand{\ZOGY}{\citetalias{2016ApJ...830...27Z}}
\newcommand{\AL}{\citetalias{1998ApJ...503..325A}}

%If you want glossaries
%\input{aglossary.tex}
%\makeglossaries

\title{Practical, nearly-proper image subtraction, yet again}

% Optional subtitle
% \setDocSubtitle{A subtitle}

\author{%
Jim Bosch
}

\setDocRef{DMTN-196}
\setDocUpstreamLocation{\url{https://github.com/lsst-dm/dmtn-196}}

\date{\vcsDate}

% Optional: name of the document's curator
% \setDocCurator{The Curator of this Document}

\setDocAbstract{%
The "proper image subtraction" of \citet{2016ApJ...830...27Z} (hereafter \ZOGY{}) has theoretical advantages and practical disadvantages compared to the method of \citet{1998ApJ...503..325A} (hereafter \AL{}).
This technote proposes a hybrid; it is not the first such attempt (see \citeds{DMTN-021} and especially \citeds{DMTN-179} for very closely related ideas), but it seems to be one not yet considered.
}

% Change history defined here.
% Order: oldest first.
% Fields: VERSION, DATE, DESCRIPTION, OWNER NAME.
% See LPM-51 for version number policy.
\setDocChangeRecord{%
  \addtohist{1}{YYYY-MM-DD}{Unreleased.}{Jim Bosch}
}


\begin{document}

% Create the title page.
\mkshorttitle
% Frequently for a technote we do not want a title page  uncomment this to remove the title page and changelog.
% use \mkshorttitle to remove the extra pages

\section{Introduction and Related Work}

The \ZOGY{} algorithm is a formally optimal approach to image subtraction when the PSFs of the images being subtracted are perfectly known, and it gracefully handles any combination of PSF sizes.
In practice, the PSFs are not known exactly, and two serious problems occur:
\begin{itemize}
  \item Fourier division by terms involving the (noisy) PSF leave artifacts in the image;
  \item In crowded fields, it may be hard to robustly build PSF models that are good enough to avoid serious subtraction artifacts.
\end{itemize}

The older \AL{} algorithm avoids both of these problems, by working directly in the image domain (at least in all existing implementations) and solving directly for the difference kernel, rather than either PSF.
It is optimal (and equivalent to \ZOGY{}) in the limit that the template has no noise.
When the template has noise, it suffers from correlated noise in the difference image.
When the template PSF is also larger than the science image PSF, it can also suffer from deconvolution artifacts.
The latter is by far the most serious problem; usually the noise in the template is sufficiently low that the S/N loss is minimal, and the noise can be decorrelated via an ``afterburner'' as described in \citeds{DMTN-021}.

One frequently-discussed approach (from Robert Lupton) to address this is to first ``preconvolve'' the science image by its own PSF (or, more precisely, its transpose), because for \emph{detection} we want to work with this PSF-convolved ``score'' or ``likelihood map'' image anyway, and with sufficient care other algorithms (e.g. photometry) can be rewritten to work on these images as well.
Applying preconvolution rigorously requires accounting for noise correlations when performing the least-squares fit for the difference kernel, however, and rewriting all measurement algorithms to work on score images is at best a lot of work; there may be cases (especially those involving blends and reporting uncertainties) that cannot be made to run \emph{efficiently} on such an image at all.

\citeds{DMTN-179} provides a thorough overview of the relationship between \ZOGY{} and \AL{} and their practical failure modes, including derivations that are \emph{extremely} similar to those in the next section, without (as far as I can tell) directly considering this algorithm or evaluating its feasibility.

\section{Algorithm}

Our target is a simplified version of the \ZOGY{} formula for a proper (decorrelated, non-score) difference image in the Fourier domain (their eq. 13):

\begin{align}
  \widetilde{z_D}(k) & = \frac{
    \widetilde{\phi_T}(k) \, \widetilde{z_S}(k)
    - \widetilde{\phi_S}(k) \, \widetilde{z_T}(k)
  }{
    \sqrt{
      \sigma_S^2 \, \left|\widetilde{\phi_T}(k)\right|^2
      + \sigma_T^2 \, \left|\widetilde{\phi_S}(k)\right|^2
    }
  }
\end{align}
where
\begin{itemize}
  \item $\widetilde{f}(k)$ represents the Fourier transform of $f(x)$;
  \item $z_T(x)$ and $z_S(x)$ are the template and science images, respectively;
  \item $\phi_T(x)$ and $\phi_S(x)$ are their true (unknown) PSFs and photometric calibration factors (assumed spatially constant for now);
  \item $\sigma_T$ and $\sigma_S$ are their per-pixel noise levels (assumed spatially constant);
  \item $z_D(x)$ is the difference image.
\end{itemize}
We have combined the PSFs and photometric calibration terms both for notational simplify and to reflect the fact that we may want to solve for the photometric scaling of the science image.
Once can equivalently assume instead that either or both images are already in the desired flux units and $\phi$ is already normalized to integrate to unity; this will generally be true for the template in practice.

We now introduce analytic approximations $P_T(x)$ and $P_S(x)$ to the true template and science image PSFs $\phi_T(x)$ and $\phi_S$; these could be (e.g.) Gaussian or double-Gaussian profiles of approximately the same shapes.
We will derive other requirements on the nature of these approximations as we go.

The Fourier difference image is unchanged if we multiply both the numerator and denominator by $\widetilde{P_T}/\widetilde{\phi_T}$:

\begin{align}
  \widetilde{z_D}(k) & = \frac{
    \widetilde{P_T}(k) \, \widetilde{z_S}(k)
    - \frac{
        \widetilde{P_T}(k) \, \widetilde{\phi_S}(k)
      }{
        \widetilde{\phi_T}(k)
      }\, \widetilde{z_T}(k)
  }{
    \sqrt{
      \sigma_S^2 \, \left|\widetilde{P_T}(k)\right|^2
      + \sigma_T^2 \, \frac{
        \left|\widetilde{\phi_S}(k)\right|^2
        \left|\widetilde{P_T}(k)\right|^2
      }{
        \left|\widetilde{\phi_T}(k)\right|^2
      }
    }
  }
\end{align}

We will now make two actual approximations to the difference image: we will assume $\phi_T(x) = P_T(x)$ and $\phi_S(x) = P_S(x)$ \emph{in the denominator only:}

\begin{align}
  \widetilde{z_D}(k) & \approx \frac{
    \widetilde{P_T}(k) \, \widetilde{z_S}(k)
    - \frac{
        \widetilde{P_T}(k) \, \widetilde{\phi_S}(k)
      }{
        \widetilde{\phi_T}(k)
      }\, \widetilde{z_T}(k)
  }{
    \sqrt{
      \sigma_S^2 \, \left|\widetilde{P_T}(k)\right|^2
      + \sigma_T^2 \, \left|\widetilde{P_S}(k)\right|^2
    }
  }
\end{align}

This approximation does not affect the quality of the subtraction, as it amounts to [de]convolving the optimal difference image by a small kernel, hence leaving the noise slightly correlated.

We now identify the two Fourier products for the two images as distinct kernels, and consider the subtraction in the image-domain:
\begin{align}
  \widetilde{z_D}(k) & \approx \widetilde{V}(k) \, \widetilde{z_S}
    - \widetilde{K}(k) \, \widetilde{z_T} \\
  \widetilde{V}(k) & \equiv \frac{
    \widetilde{P_T}(k)
  }{
    \sqrt{
      \sigma_S^2 \, \left|\widetilde{P_T}(k)\right|^2
      + \sigma_T^2 \, \left|\widetilde{P_S}(k)\right|^2
    }
  } \label{eqn:preconvolution-kernel} \\
  \widetilde{K}(k) & \equiv \frac{
      \widetilde{P_T}(k) \, \widetilde{\phi_S}(k)
  }{
    \widetilde{\phi_T}(k) \,
    \sqrt{
      \sigma_S^2 \, \left|\widetilde{P_T}(k)\right|^2
      + \sigma_T^2 \, \left|\widetilde{P_S}(k)\right|^2
    }
  } \\
  z_D(x) & \approx \left[V \ast z_S\right](x) - \left[K \ast z_T\right](x)
\end{align}
$V$ is a preconvolution kernel, comprised entirely of analytic approximations that we consider inputs to the algorithm.\footnote{Providing a rough analytic approximation the PSF is a much lower bar than the high-quality PSF models demanded by \ZOGY{}, even in crowded fields.}
$K$ is a difference kernel that we can now solve for via least squares, just as in \AL{}, by introducing some model for $K$ with parameters $\theta$:
\begin{align}
  \underset{\theta}{\text{min}} \sum_x \left(
      \left[V \ast z_S\right](x) - \left[K(\theta) \ast z_T\right](x)
    \right)^2
  \label{eqn:least-squares}
\end{align}

When the approximate PSFs are good, the residual image has nearly uncorrelated noise and hence we can consider each \emph{residual} pixel an independent data point in our optimization.

For this algorithm to be practical, we need to be able to define $P_T$ and $P_S$ such that $V$ and $K$ are net convolutions, while still making them close enough to the true (and unknown) $\phi_T$ and $\phi_S$ to make ignoring correlations in [\ref{eqn:least-squares}] acceptable.

As long as our PSF approximations $P_T$ and $P_S$ are monotonically decreasing in Fourier space (using Gaussians clearly satisfies this), then $\widetilde{V}$ also monotonically decreasing and a net convolution by construction, regardless of the noise or the relative scales of the PSF approximations (and the true PSFs do not enter at all), because the denominator of [\ref{eqn:preconvolution-kernel}] cannot have zeros except where the numerator does.

Unfortunately, the same is not true of $K$.
For further insight, we can decompose $\widetilde{K}$ into the product of the true PSF Fourier ratio $\widetilde{R} = \widetilde{\phi_S}/\widetilde{\phi_T}$ and $\widetilde{V}$:
\begin{align}
  \widetilde{K}(k) & = \frac{
    \widetilde{P_T}(k)
  }{
    \sqrt{
      \sigma_S^2 \, \left|\widetilde{P_T}(k)\right|^2
      + \sigma_T^2 \, \left|\widetilde{P_S}(k)\right|^2
    }
  }
  \;
  \frac{\widetilde{\phi_S}(k)}{\widetilde{\phi_T}(k)}
  = \widetilde{V}(k) \, \widetilde{R}(k) \; .
\end{align}
In the limit where the template PSF is smaller than the science image PSF, or more precisely,
\begin{align}
  \text{supp}\,\widetilde{\phi_S}(k) \in \text{supp}\,\widetilde{\phi_T}(k) \; ,
\end{align}
then $R$ and $V$ are both net convolutions and our algorithm is safe.

When this is not the case, we need to choose $P_S$ and $P_T$ to satisfy
\begin{align}
  \text{supp}\,\widetilde{\phi_S}(k)\,\widetilde{P_T}(k)
  \in \text{supp}\,\widetilde{\phi_T}(k) \, \sqrt{
    \sigma_S^2 \, \left|\widetilde{P_T}(k)\right|^2
    + \sigma_T^2 \, \left|\widetilde{P_S}(k)\right|^2
  } \; .
\end{align}
We cannot expand the right-hand side if it is already limited by the lack of high-frequency $k$ modes in the template PSF, but we can shrink the left-hand side to fit, by making $P_T$ broader and hence its support in $k$ smaller.

Put another way: we should try to make our initial $P_T$ a bit larger than the true template PSF $\phi_T$.
If $K$ gets dangerously close to a deconvolution in any direction as we iterate, we can make $P_T$ broader (actually just broadening $V$ / smoothing $V z_S$) to stabilize the algorithm.

The algorithm's stability has no similarly direct dependence on $P_S$, but the quality of that approximation does play a role in decorrelating the noise, and it is important that it be monotonically decreasing and noise-free in the Fourier domain to guarantee that $V$ is a convolution.
Picking a form and parameters for $P_S$ that make the construction of $V$ and $V \ast z_S$ efficient for a width-parameterized $P_T$ may be useful, in order to provide a way to easily increase $V$ as needed in the directions that most help with stability.



\appendix
% Include all the relevant bib files.
% https://lsst-texmf.lsst.io/lsstdoc.html#bibliographies
\section{References} \label{sec:bib}
\renewcommand{\refname}{} % Suppress default Bibliography section
\bibliography{local,lsst,lsst-dm,refs_ads,refs,books}

% Make sure lsst-texmf/bin/generateAcronyms.py is in your path
\section{Acronyms} \label{sec:acronyms}
\input{acronyms.tex}
% If you want glossary uncomment below -- comment out the two lines above
%\printglossaries





\end{document}
